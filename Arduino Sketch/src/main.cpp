/*
ESP32 Pager Proof Of Concept
This code implements a basic pager, initally designed for DAPNET use, but can be modified to suit any need.

Additional files:
-config.h contains the user configuration (frequency, offset, RIC, ringtones, etc)
-periph.h contains pin assignment

Frequency offset must be configured for reliable decoding. At present time, there isn't a "cal" mode available, but it is to be implemented.


*/
#include <Arduino.h>
#include "periph.h"
#include "config.h"
#include <RadioLib.h>
#include <SPI.h>
#include <Wire.h>
#include <Wifi.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

const unsigned char displayLogo[] PROGMEM = {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x1f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x3f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x7f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x7c, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0xf8, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0xf0, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0xf0, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0xf0, 0x3c, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0xfc, 0x7e, 0x03, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x7f, 0xff, 0x0f, 0xff, 0x80, 0xff, 0x80, 0x7c, 0x1f, 0xf0, 0xe0, 0x73, 0xff, 0x9f, 0xfc,
        0x00, 0x3f, 0xff, 0xdf, 0xff, 0xc0, 0xff, 0xc0, 0x7c, 0x1f, 0xf8, 0xf0, 0x73, 0xff, 0x9f, 0xfc,
        0x00, 0x3f, 0xf3, 0xff, 0xcf, 0xc0, 0xff, 0xe0, 0x7c, 0x1f, 0xfc, 0xf8, 0x73, 0xff, 0x9f, 0xfc,
        0x00, 0x0f, 0xc0, 0xfe, 0x03, 0xe0, 0xe0, 0xe0, 0xee, 0x1c, 0x1c, 0xf8, 0x73, 0x80, 0x01, 0xc0,
        0x00, 0x00, 0x00, 0x7c, 0x01, 0xf0, 0xe0, 0xf0, 0xee, 0x1c, 0x1c, 0xfc, 0x73, 0x80, 0x01, 0xc0,
        0x00, 0x00, 0x00, 0x7c, 0x00, 0xf0, 0xe0, 0x70, 0xee, 0x1c, 0x1c, 0xec, 0x73, 0x80, 0x01, 0xc0,
        0x00, 0x00, 0x00, 0x78, 0x00, 0xe0, 0xe0, 0x70, 0xc7, 0x1f, 0xfc, 0xee, 0x73, 0xff, 0x01, 0xc0,
        0x00, 0xff, 0x80, 0x78, 0x00, 0xf0, 0xe0, 0x71, 0xc7, 0x1f, 0xf8, 0xe6, 0x73, 0xff, 0x01, 0xc0,
        0x01, 0xff, 0xc0, 0x78, 0x00, 0xf0, 0xe0, 0x71, 0xc7, 0x1f, 0xf0, 0xe7, 0x73, 0xff, 0x01, 0xc0,
        0x07, 0xff, 0xf0, 0x7c, 0x00, 0xf0, 0xe0, 0x71, 0xff, 0x1c, 0x00, 0xe3, 0x73, 0x80, 0x01, 0xc0,
        0x0f, 0xff, 0xf8, 0x7c, 0x00, 0xf0, 0xe0, 0x73, 0xff, 0x9c, 0x00, 0xe3, 0xf3, 0x80, 0x01, 0xc0,
        0x1f, 0x80, 0xfd, 0xfe, 0x01, 0xf0, 0xe0, 0xe3, 0xff, 0x9c, 0x00, 0xe1, 0xf3, 0x80, 0x01, 0xc0,
        0x1f, 0x00, 0x7f, 0xff, 0x03, 0xe0, 0xff, 0xe3, 0x83, 0x9c, 0x00, 0xe1, 0xf3, 0xff, 0x81, 0xc0,
        0x3c, 0x00, 0x3f, 0xdf, 0xff, 0xc0, 0xff, 0xc7, 0x01, 0xdc, 0x00, 0xe0, 0xf3, 0xff, 0x81, 0xc0,
        0x3c, 0x00, 0x1f, 0x0f, 0xff, 0xc0, 0xff, 0x07, 0x01, 0xdc, 0x00, 0xe0, 0x73, 0xff, 0x81, 0xc0,
        0x3c, 0x00, 0x0f, 0x07, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x78, 0x00, 0x0f, 0x03, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x78, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x78, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x78, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x07, 0xc3, 0x83, 0xcf, 0xbe, 0x00, 0x18, 0xce, 0x03, 0x00,
        0x78, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x06, 0x63, 0x86, 0x6c, 0x33, 0x00, 0x18, 0xdb, 0x07, 0x00,
        0x3c, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x06, 0x66, 0xcc, 0x0c, 0x33, 0x00, 0x0d, 0x9b, 0x0f, 0x00,
        0x3c, 0x00, 0x1e, 0x00, 0x00, 0x00, 0x06, 0x66, 0xcc, 0x0f, 0xb3, 0x00, 0x0d, 0x9b, 0x0b, 0x00,
        0x3e, 0x00, 0x3c, 0x00, 0x00, 0x00, 0x07, 0xc6, 0xcc, 0xec, 0x3e, 0x00, 0x0d, 0x9b, 0x03, 0x00,
        0x1f, 0x00, 0x7c, 0x00, 0x00, 0x00, 0x06, 0x0f, 0xec, 0x6c, 0x36, 0x0e, 0x0d, 0x9b, 0x03, 0x00,
        0x0f, 0xe3, 0xf8, 0x00, 0x00, 0x00, 0x06, 0x0c, 0x66, 0x6c, 0x33, 0x00, 0x07, 0x1b, 0x63, 0x00,
        0x0f, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x06, 0x0c, 0x63, 0xcf, 0xb1, 0x80, 0x07, 0x0e, 0x63, 0x00,
        0x03, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x01, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
}; // DAPNET logo 128x64px (1 bit per pixel)


SX1278 radio = new Module(LORA_SS, LORA_DIO0, LORA_RST, LORA_DIO1); // Radio module instance
// create Pager client instance using the FSK module
PagerClient pager(&radio); // Pager client instance

#define SCREEN_ADDRESS 0x3C  ///< See datasheet for Address; 0x3D for 128x64, 0x3C for 128x32
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RST); // OLED display instance

void pocsagInit() {
    // initialize SX1278 with default settings
    Serial.print(F("[SX1278] Initializing ... ")); // Print a message to the serial port
    int state = radio.beginFSK(); // Initialize the radio module

    if (state == RADIOLIB_ERR_NONE) {
        Serial.println(F("success!")); // Report success
    } else {
        Serial.print(F("failed, code "));
        Serial.println(state); // Report error
        while (true); // Halt
    }

    // initialize Pager client
    Serial.print(F("[Pager] Initializing ... ")); // Print a message to the serial port
    state = pager.begin(frequency + offset, 1200); // Initialize the pager client
    if (state == RADIOLIB_ERR_NONE) {
        Serial.println(F("success!")); // Report success
    } else {
        Serial.print(F("failed, code ")); // Report error
        Serial.println(state); // Report error
        while (true); // Halt
    }
}

void pocsagStartRx() {
    // start receiving POCSAG messages
    Serial.print(F("[Pager] Starting to listen ... ")); // Print a message to the serial port
    // address of this "pager":     1234567
    int state = pager.startReceive(LORA_DIO2, 200, 0); // Start receiving messages
    if (state == RADIOLIB_ERR_NONE) {
        Serial.println(F("success!")); // Report success
    } else {
        Serial.print(F("failed, code ")); // Report error
        Serial.println(state); // Report error
        while (true); // Halt
    }
}

void displayInit() {

    // SSD1306_SWITCHCAPVCC = generate display voltage from 3.3V internally
    if (!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS)) {
        Serial.println(F("SSD1306 allocation failed")); // Report error
        while (true);  // Don't proceed, loop forever
    }
    // Clear the buffer
    display.clearDisplay();  // clears the screen and buffer
    display.drawBitmap(0, 0, displayLogo, 128, 64, WHITE); // Draw the logo
    display.display(); // Display the logo
}

void setup() {
    Serial.begin(115200); // Initialize serial port
    pinMode(LED, OUTPUT); // Set LED pin as output
    displayInit(); // Initialize the display
    pocsagInit(); // Initialize the pager
    pocsagStartRx(); // Start receiving messages
}

void displayPage(String address, String text) { // Display the received message
    display.clearDisplay(); // Clear the display
    display.setTextSize(2); // Set the text size
    display.setTextColor(WHITE); // Set the text color
    display.setCursor(0, 0); // Set the cursor position
    display.print("Received:"); // Print the text
    display.setCursor(0, 16); // Set the cursor position
    display.print(address); // Print the address
    display.setTextSize(1); // Set the text size
    display.setCursor(0, 32); // Set the cursor position
    display.print(text); // Print the text
    display.display(); // Display the text
}

void ringBuzzer(int ringToneChoice) {
    for (int i = 0; i < NOTENUMBER; i++) {
        tone(BUZZER, beepTones[ringToneChoice][i], 130); // Play the tone
    }
    for (int i = 0; i < 20; i++) { // Blink the LED
        digitalWrite(LED, HIGH); // Turn the LED on
        delay(100); // Wait for 100 millisecond(s)
        digitalWrite(LED, LOW); // Turn the LED off
        delay(100); // Wait for 100 millisecond(s)
    }
}

void loop() {
    // the number of batches to wait for
    // 2 batches will usually be enough to fit short and medium messages
    if (pager.available() >= 2) {
        Serial.print(F("[Pager] Received pager data, decoding ... ")); // Print a message to the serial port
        // you can read the data as an Arduino String
        String str; // Create a string
        uint32_t addr = 0; // Create a variable to store the address
        int state = pager.readData(str, 0, &addr); // Read the data
        if (state == RADIOLIB_ERR_NONE) { // Check for errors
            Serial.println(F("success!")); // Report success

            // print the received data
            Serial.print(F("[Pager] Address:\t")); // Print a message to the serial port
            Serial.print(String(addr)); // Print the address
            Serial.print(F("[Pager] Data:\t")); // Print a message to the serial port
            Serial.println(str); // Print the data

            for (int i = 0; i < RICNUMBER; i++) { // Check if the address is in the list
                if (addr == ric[i].ricvalue) { // If the address is in the list
                    displayPage(ric[i].name, str); // Display the message
                    ringBuzzer(ric[i].ringtype); // Ring the buzzer
                }
            }
        } else {
            Serial.print(F("failed, code ")); // Report error
            Serial.println(state);  // Report error
        }
    }
}